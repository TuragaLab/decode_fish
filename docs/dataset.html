---

title: Dataset and transformations


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/08_dataset.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/08_dataset.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DecodeDataset" class="doc_header"><code>class</code> <code>DecodeDataset</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L16" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DecodeDataset</code>(<strong><code>path</code></strong>:<code>Union</code>[<code>str</code>, <code>list</code>], <strong><code>dataset_tfms</code></strong>:<code>list</code>, <strong><code>rate_transform</code></strong>:<code>list</code>, <strong><code>bg_transform</code></strong>:<code>list</code>, <strong><code>num_iter</code></strong>:<code>int</code>=<em><code>5000</code></em>, <strong><code>device</code></strong>:<code>str</code>=<em><code>'cpu'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="print_class_signature" class="doc_header"><code>print_class_signature</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L72" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>print_class_signature</code>(<strong><code>nms</code></strong>)</p>
</blockquote>

<pre><code>print class signature</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TransformBase" class="doc_header"><code>class</code> <code>TransformBase</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L78" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TransformBase</code>()</p>
</blockquote>

<pre><code>All transformations optionally must be inherited from this class for nice
representations and checks if input to given transformations is a tensor</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ScaleTensor" class="doc_header"><code>class</code> <code>ScaleTensor</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L98" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ScaleTensor</code>(<strong><code>low</code></strong>:<code>float</code>, <strong><code>high</code></strong>:<code>float</code>, <strong><code>data_min</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>data_max</code></strong>:<code>float</code>=<em><code>1.0</code></em>) :: <a href="/decode_fish/dataset.html#TransformBase"><code>TransformBase</code></a></p>
</blockquote>

<pre><code>
Scales given `torch.Tensor` between `low` and `high`


Parameters:

`low`     : lower bound

`high`    : upper bound

`data_min`: max value of data

`data_max`: min value of main data


Returns:

Scaled tensor</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EstimateBackground" class="doc_header"><code>class</code> <code>EstimateBackground</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L124" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EstimateBackground</code>(<strong><code>smoothing_filter_size</code></strong>, <strong><code>div_factor</code></strong>=<em><code>1</code></em>) :: <a href="/decode_fish/dataset.html#TransformBase"><code>TransformBase</code></a></p>
</blockquote>

<pre><code>All transformations optionally must be inherited from this class for nice
representations and checks if input to given transformations is a tensor</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_forward_scaling" class="doc_header"><code>get_forward_scaling</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_forward_scaling</code>(<strong><code>img</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RandomCrop3D" class="doc_header"><code>class</code> <code>RandomCrop3D</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L141" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RandomCrop3D</code>(<strong><code>crop_sz</code></strong>, <strong><code>roi_mask</code></strong>) :: <a href="/decode_fish/dataset.html#TransformBase"><code>TransformBase</code></a></p>
</blockquote>

<pre><code>    Ramdomly Crops 3D tensor.


This class will generate random crop of `crop_sz`. This calss is initilize
    with `img_sz` which should be a demension of 4 [Channel, Height, Width, Depth] and
    a `crop_sz` dimesnion of 3 [Height, Width, Depth] of desired crop. For each crop
    dimension `_get_slice` function will calculate random int ranging from 0 to (img_sz-crop_sz).
    and return tuple of containing two slice intergers. If one dimension of `img_sz` matches
    one dimension of `crop_sz` the resulting tuple will be `(None, None)` which will result
    in not croping this particular dimension.



Parameters:

`img_sz`     : Size of the 3D image `(C, H, W, D)`

`crop_sz`    : Size of the 3D crop  `(H, W, D)`


Returns:

Croped 3D image of the given `crop_sz`</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_roi_mask" class="doc_header"><code>get_roi_mask</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L193" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_roi_mask</code>(<strong><code>img</code></strong>, <strong><code>pool_size</code></strong>=<em><code>(10, 10, 10)</code></em>, <strong><code>percentile</code></strong>=<em><code>50</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">decode_fish.funcs.file_io</span> <span class="kn">import</span> <span class="n">load_psf_micro_psf_noise</span>
<span class="kn">from</span> <span class="nn">decode_fish.engine.point_process</span> <span class="kn">import</span> <span class="n">PointProcessUniform</span>
<span class="kn">from</span> <span class="nn">decode_fish.funcs.plotting</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img_3d</span> <span class="o">=</span> <span class="n">load_tiff_image</span><span class="p">(</span><span class="s1">&#39;/groups/turaga/home/speisera/share_TUM/FishSIM/sim_1/mRNAlevel_200/cell3D/strong/w1_HelaKyoto_Gapdh_2597_p01_cy3__Cell_CP_14__cell3D__1.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">estimate_backg</span> <span class="o">=</span> <span class="n">EstimateBackground</span><span class="p">(</span><span class="n">smoothing_filter_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">div_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">roi_mask</span>       <span class="o">=</span> <span class="n">get_roi_mask</span><span class="p">(</span><span class="n">img_3d</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
<span class="n">rand_crop</span>      <span class="o">=</span> <span class="n">RandomCrop3D</span><span class="p">((</span><span class="mi">48</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">48</span><span class="p">),</span> <span class="n">roi_mask</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">probmap_generator</span> <span class="o">=</span> <span class="n">ScaleTensor</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.00000001</span><span class="p">,</span> 
                                <span class="n">high</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> 
                                <span class="n">data_min</span> <span class="o">=</span> <span class="n">img_3d</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
                                <span class="n">data_max</span> <span class="o">=</span> <span class="n">img_3d</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">DecodeDataset</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/groups/turaga/home/speisera/share_TUM/FishSIM/sim_1/mRNAlevel_200/cell3D/strong/w1_HelaKyoto_Gapdh_2597_p01_cy3__Cell_CP_14__cell3D__1.tif&#39;</span><span class="p">,</span>
                   <span class="n">dataset_tfms</span> <span class="o">=</span>  <span class="p">[</span><span class="n">rand_crop</span><span class="p">],</span> 
                   <span class="n">rate_transform</span> <span class="o">=</span> <span class="n">probmap_generator</span><span class="p">,</span> 
                   <span class="n">bg_transform</span> <span class="o">=</span> <span class="n">estimate_backg</span><span class="p">,</span> 
                   <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">,</span> 
                   <span class="n">num_iter</span><span class="o">=</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">decode_dl</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">local_rate</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">decode_dl</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cfg</span> <span class="o">=</span> <span class="n">OmegaConf</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">default_conf</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">psf</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">micro</span> <span class="o">=</span> <span class="n">load_psf_micro_psf_noise</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_dataloader" class="doc_header"><code>get_dataloader</code><a href="https://github.com/TuragaLab/decode_fish/tree/master/decode_fish/funcs/dataset.py#L202" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_dataloader</code>(<strong><code>cfg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>nbdev_build_lib
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_models.ipynb.
Converted 01_psf.ipynb.
Converted 02_microscope.ipynb.
Converted 03_noise.ipynb.
Converted 04_pointsource.ipynb.
Converted 05_gmm_loss.ipynb.
Converted 06_plotting.ipynb.
Converted 07_file_io.ipynb.
Converted 08_dataset.ipynb.
Converted 09_output_trafo.ipynb.
Converted 10_evaluation.ipynb.
Converted 11_emitter_io.ipynb.
Converted 12_utils.ipynb.
Converted 13_train_sl.ipynb.
Converted 14_train_ae.ipynb.
Converted 15_fit_psf.ipynb.
Converted 16_visualization.ipynb.
Converted index.ipynb.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

